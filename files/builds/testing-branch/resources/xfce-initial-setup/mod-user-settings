#!/bin/bash

####################################################################################################
# Name:         openSUSE Baldur (MicroOS with XFCE) - User Configurator                            #
# Description:  This file will configure the user settings on openSUSE Baldur.                     #
# Author:       Steve Zabka                                                                        #
# Author URI:   https://cryinkfly.com                                                              #
# License:      MIT                                                                                #
# Copyright (c) 2023                                                                               #
# Time/Date:    xx:xx/xx.xx.xxxx                                                                   #
# Version:      1.0.x                                                                              #
####################################################################################################

##############################################################################################################################################################################
# CONFIGURATION OF THE COLOR SCHEME:                                                                                                                                         #
##############################################################################################################################################################################

function LOAD_COLOR_SHEME {
    RED=$'\033[0;31m'
    YELLOW=$'\033[0;33m'
    GREEN=$'\033[0;32m'
    NOCOLOR=$'\033[0m'
}


##############################################################################################################################################################################
# LIST OF ALL HUMAN USERS ON THIS SYSTEM:                                                                                                                                    #
##############################################################################################################################################################################

function LIST_ALL_HUMAN_USERS {
    list_user_groups=$(cut -d: -f1,3 /etc/passwd | egrep ':[0-9]{4}$' | cut -d: -f1)
}

##############################################################################################################################################################################
# LIST OF ALL GROUPS ON THIS SYSTEM (/etc/group):                                                                                                                            #
##############################################################################################################################################################################

function LIST_ALL_GROUPS {
    list_user_groups=$(cut -d: -f1 /etc/group | sort)
}

##############################################################################################################################################################################
# DISPLAY INFORMATION ABOUT A USER (USERNAME, USER GROUPS, ...):                                                                                                             #
##############################################################################################################################################################################



##############################################################################################################################################################################
# CREATE A NEW USER PASSWORD:                                                                                                                                                #
##############################################################################################################################################################################

function SET_NEW_USER {
    userdata=`zenity --forms \
        --title="Benutzerkonto anlegen" \
        --text="<span font='9'>Sie müssen einen <span color='#2C423F'>Benutzername</span> für die reguläre\n(nicht-administrative) Nutzung Ihres Systems anlegen.\nUm einen <span color='#2C423F'>System-Benutzernamen</span> anzulegen, geben\nSie unten die erforderlichen Informationen ein.</span>" \
        --add-entry="Vollständiger Name:" \
        --add-entry="Benutzername:" \
        --add-password="Passwort:" \
        --add-password="Passwort bestätigen:" \
        --separator="," \
        --ok-label="Benutzer hinzufügen" \
        --cancel-label="Überspringen"`

    accepted=$?
    if ((accepted != 0)); then
        zenity --info --title="Wichtige Information" --text="Die Einrichtung eines neuen Benutzerkontos wurde übersprungen! Sie können jederzeit über die XFCE-Settings einen neuen Benutzer anlegen."
        USER-SETTINGS
    fi

    name=$(awk -F, '{print $1}' <<<$userdata)
    username=$(awk -F, '{print $2}' <<<$userdata)
    password0=$(awk -F, '{print $3}' <<<$userdata)
    password1=$(awk -F, '{print $4}' <<<$userdata)
    
    egrep "^$username" /etc/passwd >/dev/null
    if [ $? -eq 0 ]; then
		zenity --warning --title="Ein Fehler ist aufgetreten" --text="Der eingegebene Benutzername ist auf diesem System bereits vorhanden!\nBitte wähle einen anderen Benutzername."
		SET_NEW_USER
	else
		if [ $password0 == $password1 ]; then
            pass=$(perl -e 'print crypt($ARGV[0], "password")' $password0)
            pkexec su -c "useradd -m -p '$pass' $username"
            zenity --info --title="Benutzerkonto anlegen" --text="Das Benutzerkonto wurde erfolgreich angelegt und Sie werden nun abgemeldet, um sich mit dem neuen Benutzerkonto anmelden zu können!"
        else
            zenity --warning --title="Ein Fehler ist aufgetreten" --text="Die eingegebenen Passwörter stimmen nicht überein!"
            SET_NEW_USER
        fi
	fi
}

##############################################################################################################################################################################
# CONFIGURATION OF THE NEW USER PASSWORD:                                                                                                                                    #
##############################################################################################################################################################################

function SET_NEW_USERPASSWORD {
    userdata=`zenity --forms \
        --title="Password ändern" \
        --text="Sie müssen ihren Benutzer auswählen" \
        --add-entry="Benutzername:" \
        --add-password="Altes Passwort:" \
        --add-password="Neues Passwort:" \
        --add-password="Neues Passwort bestätigen:" \
        --separator="," \
        --ok-label="Password ändern" \
        --cancel-label="Abbrechen"`

    accepted=$?
    if ((accepted != 0)); then
        zenity --info --title="Wichtige Information" --text="Das Passwort wurde nicht geändert!"
        USER-SETTINGS
    fi

    username=$(awk -F, '{print $1}' <<<$userdata)
    password0=$(awk -F, '{print $2}' <<<$userdata)
    password1=$(awk -F, '{print $3}' <<<$userdata)
    password2=$(awk -F, '{print $4}' <<<$userdata)

    if [ $password1 == $password2 ]; then
        if [ $password0 == $password1 ]; then
            zenity --info --title="Wichtige Information" --text="Es sollte nicht das alte Passwort wieder verwendet werden! Bitte wähle ein neues Passwort."
             SET_NEW_USERPASSWORD
        else
            pass=$(perl -e 'print crypt($ARGV[0], "password")' $password1)
            pkexec su -c "usermod -p '$pass' $username"
            zenity --info --title="Wichtige Information" --text="Das Passwort wurde erfolgreich geändert!"
        fi
    else
        zenity --warning --title="Ein Fehler ist aufgetreten" --text="Die eingegebenen neuen Passwörter stimmen nicht überein!"
        SET_NEW_USERPASSWORD
    fi
}

##############################################################################################################################################################################
# Delete user (Not the currently logged in user!):                                                                                                                           #
##############################################################################################################################################################################

# ...

#####################################################################################################################################################################################################################
# THE PROGRAM IS STARTED HERE:                                                                                                                                                                                      #
#####################################################################################################################################################################################################################

USER-SETTINGS
